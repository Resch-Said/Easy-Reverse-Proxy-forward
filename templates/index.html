<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>PortFW GUI</title>
    <style>
      body { 
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
        margin: 2em; 
        background-color: #f9f9f9;
        color: #333;
      }
      
      h1, h2 { 
        color: #2c3e50; 
        border-bottom: 2px solid #3498db;
        padding-bottom: 0.5em;
      }
      
      table { 
        border-collapse: collapse; 
        width: 100%; 
        margin-top: 1em;
        background-color: white;
        border-radius: 6px;
        overflow: hidden;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      }
      
      th { 
        background-color: #3498db; 
        color: white; 
        padding: 1em; 
        text-align: left;
        font-weight: 600;
      }
      
      td { 
        border: 1px solid #ecf0f1; 
        padding: 1em; 
        text-align: left; 
      }
      
      tr:hover { 
        background-color: #f5f9fc; 
      }
      
      form { 
        margin-bottom: 2em;
        background-color: white;
        padding: 1.5em;
        border-radius: 6px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      }
      
      label { 
        display: block; 
        margin-top: 1em;
        font-weight: 500;
        margin-bottom: 0.3em;
      }
      
      input, select { 
        padding: 0.75em; 
        width: 100%; 
        max-width: 300px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 14px;
        transition: border-color 0.3s ease;
      }
      
      input:focus, select:focus {
        outline: none;
        border-color: #3498db;
        box-shadow: 0 0 5px rgba(52, 152, 219, 0.3);
      }
      
      button, .button-link {
        display: inline-block;
        padding: 0.75em 1.5em;
        margin: 0.5em 0.5em 0.5em 0;
        margin-top: 1em;
        font-size: 14px;
        font-weight: 600;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        text-decoration: none;
        transition: all 0.3s ease;
        background-color: #3498db;
        color: white;
      }
      
      button:hover, .button-link:hover {
        background-color: #2980b9;
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.2);
      }
      
      button:active, .button-link:active {
        transform: translateY(0);
        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
      }
      
      button[type="submit"] {
        background-color: #27ae60;
      }
      
      button[type="submit"]:hover {
        background-color: #229954;
      }
      
      .button-delete, .button-danger {
        background-color: #e74c3c;
      }
      
      .button-delete:hover, .button-danger:hover {
        background-color: #c0392b;
      }
      
      .button-secondary {
        background-color: #95a5a6;
      }
      
      .button-secondary:hover {
        background-color: #7f8c8d;
      }
      
      .msg { 
        color: #e74c3c; 
        font-weight: 600;
        padding: 1em;
        background-color: #fadbd8;
        border-left: 4px solid #e74c3c;
        border-radius: 4px;
        margin-top: 1em;
      }
      
      .active { 
        color: #27ae60; 
        font-weight: bold; 
      }
      
      .inactive { 
        color: #95a5a6; 
        font-style: italic; 
      }
      
      .actions { 
        text-align: center;
        white-space: nowrap;
      }
      
      .actions form { 
        display: inline; 
        margin: 0; 
        padding: 0;
        background: none;
        box-shadow: none;
      }
      
      .actions button { 
        margin: 0 0.2em;
        padding: 0.5em 1em;
        font-size: 13px;
      }
      
      .actions .button-link { 
        margin: 0 0.2em;
        padding: 0.5em 1em;
        font-size: 13px;
      }
      
      .actions button[type="submit"]:first-child {
        background-color: #3498db;
      }
      
      .actions button[type="submit"]:first-child:hover {
        background-color: #2980b9;
      }
    </style>
  </head>
  <body>
    <h1>PortFW Reverse-Proxy GUI</h1>
    <form method="post" action="{{ '/edit' if edit_rule else '/add' }}">
            <h2>{{ 'Edit Rule' if edit_rule else 'Add New Rule' }}</h2>
            <label>Name (optional): <input type="text" name="name" maxlength="64" placeholder="Palworld, Minecraft, ..." value="{{ edit_rule.get('name', '') if edit_rule else '' }}"></label>
            <label>External Interface:
                <select name="extif">
                    {% for iface in externals %}
                        <option value="{{ iface }}" {% if edit_rule and edit_rule['extif'] == iface %}selected{% endif %}>{{ iface }}</option>
                    {% endfor %}
                </select>
            </label>
            <label>Internal VPN Interface (WireGuard, OpenVPN, Tailscale, etc.):
                <select name="intif">
                    {% for iface in internals %}
                        <option value="{{ iface }}" {% if edit_rule and edit_rule['intif'] == iface %}selected{% endif %}>{{ iface }}</option>
                    {% endfor %}
                </select>
            </label>
            <label>Protocol:
                <select name="protocol">
                    <option value="both" {% if edit_rule and edit_rule.get('protocol', 'both') == 'both' %}selected{% endif %}>TCP & UDP</option>
                    <option value="tcp" {% if edit_rule and edit_rule.get('protocol', 'both') == 'tcp' %}selected{% endif %}>TCP only</option>
                    <option value="udp" {% if edit_rule and edit_rule.get('protocol', 'both') == 'udp' %}selected{% endif %}>UDP only</option>
                </select>
            </label>
            <label>External Port: <input type="number" name="ext_port" min="1" max="65535" required value="{{ edit_rule['ext_port'] if edit_rule else '' }}"></label>
            <label>Internal Target IP: <input type="text" name="int_ip" placeholder="e.g. 192.168.178.84" required value="{{ edit_rule['int_ip'] if edit_rule else '' }}"></label>
            <label>Internal Target Port: <input type="number" name="int_port" min="1" max="65535" required value="{{ edit_rule['int_port'] if edit_rule else '' }}"></label>
            {% if edit_rule %}
            <input type="hidden" name="rule_id" value="{{ edit_index }}">
            {% endif %}
            <button type="submit">{{ 'Update' if edit_rule else 'Add' }}</button>
            {% if edit_rule %}
            <a href="/" class="button-link button-secondary">Cancel</a>
            {% endif %}
    </form>

        <h2>Current Rules</h2>
        <table>
            <tr><th>Name</th><th>Type</th><th>External</th><th>Target</th><th>Status</th><th>Actions</th></tr>
            {% for r in rules %}
            <tr>
                <td>{{ r.get('name', '') }}</td>
                <td>{{ r.get('protocol', 'both')|upper if r.get('protocol', 'both') != 'both' else 'TCP/UDP' }}</td>
                <td>{{ r['extif'] }}:{{ r['ext_port'] }}</td>
                <td>{{ r['int_ip'] }}:{{ r['int_port'] }}</td>
                <td class="{{ 'active' if r.get('enabled', True) else 'inactive' }}">
                    {{ 'Active' if r.get('enabled', True) else 'Inactive' }}
                </td>
                <td class="actions">
          <a href="/?edit={{ loop.index0 }}" class="button-link">Edit</a>
          <form method="post" action="/del" style="display:inline;">
            <input type="hidden" name="extif" value="{{ r['extif'] }}">
            <input type="hidden" name="intif" value="{{ r['intif'] }}">
            <input type="hidden" name="ext_port" value="{{ r['ext_port'] }}">
            <input type="hidden" name="int_ip" value="{{ r['int_ip'] }}">
            <input type="hidden" name="int_port" value="{{ r['int_port'] }}">
            <input type="hidden" name="protocol" value="{{ r.get('protocol', 'both') }}">
            <button type="submit" class="button-delete">Remove</button>
          </form>
          
          {% if r.get('enabled', True) %}
          <form method="post" action="/disable" style="display:inline;">
            <input type="hidden" name="extif" value="{{ r['extif'] }}">
            <input type="hidden" name="intif" value="{{ r['intif'] }}">
            <input type="hidden" name="ext_port" value="{{ r['ext_port'] }}">
            <input type="hidden" name="int_ip" value="{{ r['int_ip'] }}">
            <input type="hidden" name="int_port" value="{{ r['int_port'] }}">
            <input type="hidden" name="protocol" value="{{ r.get('protocol', 'both') }}">
            <button type="submit" class="button-danger">Disable</button>
          </form>
          {% else %}
          <form method="post" action="/enable" style="display:inline;">
            <input type="hidden" name="extif" value="{{ r['extif'] }}">
            <input type="hidden" name="intif" value="{{ r['intif'] }}">
            <input type="hidden" name="ext_port" value="{{ r['ext_port'] }}">
            <input type="hidden" name="int_ip" value="{{ r['int_ip'] }}">
            <input type="hidden" name="int_port" value="{{ r['int_port'] }}">
            <input type="hidden" name="protocol" value="{{ r.get('protocol', 'both') }}">
            <button type="submit" class="button-secondary">Enable</button>
          </form>
          {% endif %}
        </td>
      </tr>
      {% endfor %}
    </table>
  </body>
</html>
